name: Build Linux

on:
  push:
    tags: [ "v*" ]
  pull_request:
    branches: [ "main", "master" ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-linux:
    name: Build Linux (AppImage)
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y clang cmake ninja-build pkg-config libgtk-3-dev liblzma-dev build-essential libasound2-dev
          
      - uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true
          
      - name: Enable Linux Desktop
        run: flutter config --enable-linux-desktop
        
      - name: Get Dependencies
        run: flutter pub get
        
      - name: Build Linux
        run: flutter build linux --release
        
      - name: Install linuxdeploy and AppImage plugin
        run: |
          sudo apt-get install -y fuse libfuse2 file
          wget https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage
          wget https://raw.githubusercontent.com/linuxdeploy/linuxdeploy-plugin-gtk/master/linuxdeploy-plugin-gtk.sh
          chmod +x linuxdeploy-x86_64.AppImage linuxdeploy-plugin-gtk.sh
          
      - name: Package AppImage
        run: |
          # Create AppDir structure
          mkdir -p AppDir/usr/bin
          mkdir -p AppDir/usr/share/icons/hicolor/256x256/apps
          mkdir -p AppDir/usr/share/applications
          
          # Copy binary and assets
          cp -r build/linux/x64/release/bundle/* AppDir/usr/bin/
          
          # Setup Icon (Assuming assets/icon/robot_3.png exists)
          cp assets/icon/robot_3.png AppDir/usr/share/icons/hicolor/256x256/apps/synctv_app.png
          
          # Create .desktop file
          cat > AppDir/usr/share/applications/synctv_app.desktop <<EOF
          [Desktop Entry]
          Name=SyncTV
          Exec=synctv_app
          Icon=synctv_app
          Type=Application
          Categories=Utility;
          EOF
          
          # Build AppImage
          # We need to set OUTPUT environment variable or rename later
          export VERSION="${{ github.ref_name }}"
          ./linuxdeploy-x86_64.AppImage --appdir AppDir --plugin gtk --output appimage
          
          # Rename to our standard format
          mv SyncTV*.AppImage Sync-TV-Linux-x86_64-${{ github.ref_name }}.AppImage
          
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: synctv-linux-appimage
          path: Sync-TV-Linux-x86_64-${{ github.ref_name }}.AppImage

      - name: Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          generate_release_notes: true
          files: Sync-TV-Linux-x86_64-${{ github.ref_name }}.AppImage
